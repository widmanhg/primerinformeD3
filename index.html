<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Combining D3 Visualizations</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    svg {
      margin: 10px;
    }
  </style>
  <script>
    function coordsPixels(selector) {
      var txt = d3.select(selector).append('text');
      var svg = d3.select(selector).attr('cursor', 'crosshair')
        .on('mousemove', function() {
          var pt = d3.mouse(svg.node());
          txt.attr('x', 18 + pt[0])
            .attr('y', 6 + pt[1])
            .text(pt[0] + ',' + pt[1]);
        });
    }

    function makeBrush() {
      d3.csv("dense.csv").then(function(data) {
        var svg1 = d3.select("#brush1"),
            svg2 = d3.select("#brush2");

        var sc1 = d3.scaleLinear().domain([0, 10, 50]).range(["lime", "yellow", "red"]);
        var sc2 = d3.scaleLinear().domain([0, 10, 50]).range(["lime", "yellow", "blue"]);

        var cs1 = drawCircles(svg1, data, d => d["A"], d => d["B"], sc1);
        var cs2 = drawCircles(svg2, data, d => d["A"], d => d["B"], sc2);

        installHandlers(svg1, data, cs1, cs2, sc1, sc2);
      });
    }

    function drawCircles(svg, data, accX, accY, sc) {
      var color = sc(Infinity);
      return svg.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("r", 5)
        .attr("cx", accX)
        .attr("cy", accY)
        .attr("fill", color)
        .attr("fill-opacity", 0.4);
    }

    function installHandlers(svg, data, cs1, cs2, sc1, sc2) {
      svg.attr("cursor", "crosshair")
        .on("mousemove", function() {
          var pt = d3.mouse(svg.node());
          cs1.attr("fill", function(d, i) {
            var r = Math.hypot(pt[0] - d3.select(this).attr("cx"),
                               pt[1] - d3.select(this).attr("cy"));
            data[i]["r"] = r;
            return sc1(r);
          });
          cs2.attr("fill", (d, i) => sc2(data[i]["r"]));
        })
        .on("mouseleave", function() {
          cs1.attr("fill", sc1(Infinity));
          cs2.attr("fill", sc2(Infinity));
        });
    }

    function makeDragDrop() {
      var widget, color;

      var drag = d3.drag()
        .on("start", function() {
          color = d3.select(this).attr("fill");
          widget = d3.select(this).attr("fill", "lime");
        })
        .on("drag", function() {
          var pt = d3.mouse(d3.select(this).node());
          widget.attr("cx", pt[0]).attr("cy", pt[1]);
        })
        .on("end", function() {
          widget.attr("fill", color);
          widget = undefined;
        });

      drag(d3.select("#dragdrop").selectAll("circle"));
    }

    function makeStagger() {
      var ds1 = [2, 1, 3, 5, 7, 8, 9, 9, 9, 8, 7, 5, 3, 1, 2];
      var ds2 = [8, 9, 8, 7, 5, 3, 2, 1, 2, 3, 5, 7, 8, 9, 8];
      var n = ds1.length;
      var mx = d3.max(d3.merge([ds1, ds2]));
      var svg = d3.select("#stagger");

      var scX = d3.scaleLinear().domain([0, n]).range([50, 540]);
      var scY = d3.scaleLinear().domain([0, mx]).range([250, 50]);

      svg.selectAll("line").data(ds1).enter().append("line")
        .attr("stroke", "red").attr("stroke-width", 20)
        .attr("x1", (d, i) => scX(i)).attr("y1", scY(0))
        .attr("x2", (d, i) => scX(i)).attr("y2", d => scY(d));

      svg.on("click", function() {
        [ds1, ds2] = [ds2, ds1];
        svg.selectAll("line").data(ds1)
          .transition().duration(1000).delay((d, i) => 200 * i)
          .attr("y2", d => scY(d));
      });
    }

    function makeLissajous() {
      var svg = d3.select("#lissajous");
      var a = 1.9, b = 3.2;
      var phi, omega = 2 * Math.PI / 10000;
      var crrX = 150 + 100, crrY = 150 + 0;
      var prvX = crrX, prvY = crrY;

      var timer = d3.timer(function(t) {
        phi = omega * t;
        crrX = 150 + 100 * Math.cos(a * phi);
        crrY = 150 + 100 * Math.sin(b * phi);

        svg.selectAll("line")
          .each(function() { this.bogus_opacity *= .99; })
          .attr("stroke-opacity", function() { return this.bogus_opacity; })
          .filter(function() { return this.bogus_opacity < 0.05; })
          .remove();

        svg.append("line")
          .each(function() { this.bogus_opacity = 1.0; })
          .attr("x1", prvX).attr("y1", prvY)
          .attr("x2", crrX).attr("y2", crrY)
          .attr("stroke", "green").attr("stroke-width", 2);

        prvX = crrX;
        prvY = crrY;

        if (t > 120e3) { timer.stop(); }
      });
    }

    window.onload = function() {
      coordsPixels("#coords");
      makeBrush();
      makeDragDrop();
      makeStagger();
      makeLissajous();
    }
  </script>
</head>
<body>
  <h2>Coordenadas en SVG</h2>
  <svg id="coords" width="300" height="300" style="background:lightgrey"></svg>

  <h2>Brush Interactivo (requiere dense.csv)</h2>
  <svg id="brush1" width="300" height="300" style="background:lightgrey"></svg>
  <svg id="brush2" width="300" height="300" style="background:lightgrey"></svg>

  <h2>Drag & Drop</h2>
  <svg id="dragdrop" width="600" height="200" style="background:lightgrey">
    <circle cx="100" cy="100" r="20" fill="red" />
    <circle cx="300" cy="100" r="20" fill="green" />
    <circle cx="500" cy="100" r="20" fill="blue" />
  </svg>

  <h2>Barras Stagger</h2>
  <svg id="stagger" width="600" height="300" style="background:lightgrey"></svg>

  <h2>Lissajous Curve</h2>
  <svg id="lissajous" width="300" height="300" style="background:lightgrey"></svg>
</body>
</html>
